# Document Management Workflows

Diagrams for the document storage and management feature. Covers storage architecture, access control model, document lifecycle, and auto-generated document integration.

Reference: [Feature 07 - Document Storage](../features/07-document-storage.md)

---

## 1. Document Storage Architecture

Shows the relationship between Supabase Storage (file storage), the documents table (metadata), and polymorphic entity linking.

```mermaid
flowchart TD
    subgraph storage["Supabase Storage"]
        BUCKET["scheme-documents bucket<br/>(private, RLS-protected)"]
        BUCKET --> PATH["Path format:<br/>{scheme_id}/{category}/{year}/{filename}"]

        subgraph folders["Folder Structure per Scheme"]
            F1["agm/"]
            F2["levy-notices/"]
            F3["financial/"]
            F4["insurance/"]
            F5["bylaws/"]
            F6["correspondence/"]
            F7["maintenance/"]
            F8["contracts/"]
            F9["building-reports/"]
            F10["other/"]
        end
    end

    subgraph database["PostgreSQL (documents table)"]
        DOC["documents<br/>id, scheme_id, filename,<br/>category, visibility,<br/>file_path, file_size, mime_type,<br/>linked_entity_type, linked_entity_id,<br/>version_number, uploaded_by"]

        VERSIONS["document_versions<br/>document_id, version_number,<br/>file_path, uploaded_by"]

        AUDIT["document_audit_log<br/>document_id, user_id,<br/>action (view/download/upload/delete),<br/>ip_address, timestamp"]
    end

    subgraph linking["Polymorphic Entity Links"]
        L1["linked_entity_type = 'meeting'<br/>linked_entity_id = meeting.id"]
        L2["linked_entity_type = 'levy'<br/>linked_entity_id = levy_item.id"]
        L3["linked_entity_type = 'maintenance_request'<br/>linked_entity_id = request.id"]
        L4["linked_entity_type = 'financial_report'<br/>linked_entity_id = report.id"]
    end

    PATH --> DOC
    DOC --> VERSIONS
    DOC --> AUDIT
    DOC --> linking

    style storage fill:#e6f3ff,stroke:#0066cc
    style database fill:#fff3e6,stroke:#cc6600
    style linking fill:#f0e6ff,stroke:#6600cc
```

---

## 2. Document Visibility & Access Control

Shows who can access documents based on the visibility setting and user role. Three tiers: owners (broadest), committee, and manager_only (most restricted).

```mermaid
flowchart TD
    DOC["Document<br/>visibility field"] --> VIS{visibility?}

    VIS -->|"owners"| OWNERS_ACCESS["Visible to:<br/>- Manager (full access)<br/>- Admin (read/write, no delete)<br/>- Committee members (read)<br/>- All lot owners in scheme (read)<br/>- Auditors (financial/agm only)"]

    VIS -->|"committee"| COMMITTEE_ACCESS["Visible to:<br/>- Manager (full access)<br/>- Admin (read/write, no delete)<br/>- Committee members (read)<br/>- NOT visible to general owners"]

    VIS -->|"manager_only"| MANAGER_ACCESS["Visible to:<br/>- Manager (full access)<br/>- Admin (read/write, no delete)<br/>- NOT visible to owners or committee"]

    subgraph rls["RLS Policy Enforcement"]
        R1["Managers: organisation_id match<br/>via auth.user_organisation_id()"]
        R2["Owners: visibility IN ('owners','committee')<br/>AND scheme_id matches their lot"]
        R3["Auditors: category IN ('financial','agm')<br/>AND scheme_id from scheme_auditors"]
    end

    OWNERS_ACCESS --> rls
    COMMITTEE_ACCESS --> rls
    MANAGER_ACCESS --> rls

    subgraph defaults["Default Visibility by Category"]
        D1["agm: owners"]
        D2["levy-notices: owners (own lot only)"]
        D3["insurance: owners (current cert)"]
        D4["bylaws: owners (current version)"]
        D5["building-reports: owners"]
        D6["financial: manager_only<br/>(except AGM financials)"]
        D7["correspondence: manager_only"]
        D8["contracts: manager_only"]
        D9["maintenance: committee<br/>(linked to request)"]
    end

    style OWNERS_ACCESS fill:#ccffcc,stroke:#00cc00
    style COMMITTEE_ACCESS fill:#ffffcc,stroke:#cccc00
    style MANAGER_ACCESS fill:#ffddcc,stroke:#cc6600
```

---

## 3. Document Lifecycle

Shows the full lifecycle of a document from upload through 7-year retention and eventual deletion.

```mermaid
stateDiagram-v2
    [*] --> upload : Manual upload or\nauto-generated by system

    upload --> draft : Version status = draft\n(not visible to owners)
    upload --> final : Version status = final\n(visible per visibility setting)

    draft --> final : Manager clicks\nMark as Final

    final --> versioned : New version uploaded\n(current becomes superseded)

    state versioned {
        [*] --> v2_draft : New version created (draft)
        v2_draft --> v2_final : Manager marks final
        v2_final --> [*]
        --
        note: Previous version marked\nsuperseded, retained in storage
    }

    final --> legal_hold : Legal dispute or\naudit requirement
    versioned --> legal_hold

    legal_hold --> final : Hold removed\n(dispute settled)

    final --> expiring : Retention date within\n90 days (warning)

    expiring --> expired : Retention date\nreached (7 years)

    expired --> soft_deleted : Auto-delete\n(categories: correspondence,\nmaintenance, other)
    expired --> extended : Manager extends\nretention (legal hold\nor business need)

    soft_deleted --> hard_deleted : 30-day grace period\npassed (unrecoverable)
    soft_deleted --> final : Manager restores\nfrom trash

    extended --> expiring : New retention\ndate approaches

    hard_deleted --> [*]

    note right of legal_hold
        Cannot be deleted
        while legal_hold = true.
        Trigger prevents deletion.
    end note

    note right of expiring
        Notifications sent:
        90 days: info email
        30 days: warning email
        7 days: urgent email
    end note
```

---

## 4. Auto-Generated Documents Integration

Shows how other LevyLite features automatically generate documents and store them in the document management system.

```mermaid
flowchart TD
    subgraph levy["Levy Management"]
        L1[Manager sends levy notices] --> L2[System generates PDF<br/>per lot per period]
        L2 --> L3["Auto-tags:<br/>levy-notice, auto-generated,<br/>{year}, {quarter}, {lot_number}"]
    end

    subgraph meeting["Meeting Administration"]
        M1[Manager finalises AGM pack] --> M2[Notice PDF generated]
        M1 --> M3[Proxy forms generated<br/>per owner]
        M1 --> M4[Minutes PDF generated<br/>after meeting]
        M2 --> M5["Auto-tags:<br/>agm-notice, auto-generated, {year}"]
        M3 --> M6["Auto-tags:<br/>proxy-form, auto-generated"]
        M4 --> M7["Auto-tags:<br/>agm-minutes, auto-generated, {year}"]
    end

    subgraph financial["Financial Reporting"]
        FR1[Manager closes financial year] --> FR2[EOFY summary PDF]
        FR1 --> FR3[Budget vs actual PDF]
        FR2 --> FR4["Auto-tags:<br/>eofy-report, auto-generated, {year}"]
        FR3 --> FR5["Auto-tags:<br/>budget-report, auto-generated, {year}"]
    end

    subgraph maint["Maintenance Tracking"]
        MT1[Manager uploads quote] --> MT2["Quote PDF stored<br/>linked to request"]
        MT3[Manager uploads invoice] --> MT4["Invoice PDF stored<br/>linked to request"]
        MT2 --> MT5["Auto-tags:<br/>quote, {trade_type}, maint-{id}"]
        MT4 --> MT6["Auto-tags:<br/>invoice, {trade_type}, maint-{id}"]
    end

    subgraph docstore["Document Storage System"]
        DS1["Upload to Supabase Storage<br/>{scheme_id}/{category}/{year}/{filename}"]
        DS2["Create documents record<br/>auto_generated = true<br/>linked_entity_type + id"]
        DS3["Audit log entry<br/>action = upload"]
        DS4["7-year retention date<br/>auto-calculated"]

        DS1 --> DS2
        DS2 --> DS3
        DS2 --> DS4
    end

    L3 --> DS1
    M5 --> DS1
    M6 --> DS1
    M7 --> DS1
    FR4 --> DS1
    FR5 --> DS1
    MT5 --> DS1
    MT6 --> DS1

    DS2 --> PORTAL["Owner Portal<br/>owners see documents<br/>matching visibility rules"]
    DS2 --> SEARCH["Full-text search<br/>tsvector index on<br/>name + description + tags"]

    style levy fill:#e6f3ff,stroke:#0066cc
    style meeting fill:#fff3e6,stroke:#cc6600
    style financial fill:#e6ffe6,stroke:#00cc00
    style maint fill:#ffe6e6,stroke:#cc0000
    style docstore fill:#f0e6ff,stroke:#6600cc
```

---

## 5. Document Version Control Flow

Shows how document versioning works with the simple replacement model.

```mermaid
sequenceDiagram
    actor Manager
    participant System as LevyLite
    participant Storage as Supabase Storage
    participant DB as documents table

    Manager->>System: Upload agm-minutes-2024.pdf
    System->>Storage: Store at scheme/agm/2024/agm-minutes-2024.pdf
    System->>DB: INSERT document (v1, status=draft,<br/>is_latest_version=true)
    System-->>Manager: Document uploaded (v1, draft)

    Note over Manager: Committee reviews, requests changes

    Manager->>System: Upload new version of same document
    System->>Storage: Store at scheme/agm/2024/agm-minutes-2024-v2.pdf
    System->>DB: UPDATE v1: is_latest_version=false,<br/>version_status=superseded,<br/>superseded_by_id=v2.id
    System->>DB: INSERT document (v2, status=draft,<br/>is_latest_version=true)
    System-->>Manager: New version uploaded (v2, draft)

    Manager->>System: Mark v2 as final
    System->>DB: UPDATE v2: version_status=final
    System-->>Manager: Document finalised (v2, final)

    Note over Manager: v2 now visible to owners<br/>v1 retained but marked superseded

    Note over Manager: Later: need to revert to v1

    Manager->>System: Restore v1
    System->>Storage: Copy v1 file to new path (-v3)
    System->>DB: UPDATE v2: is_latest_version=false,<br/>superseded_by_id=v3.id
    System->>DB: INSERT document (v3, copy of v1 content,<br/>is_latest_version=true, status=draft)
    System-->>Manager: Version restored as v3 (draft)
```

---

## 6. Retention Policy by Category

Shows the retention rules for each document category and whether auto-deletion applies.

```mermaid
flowchart LR
    subgraph categories["Document Categories"]
        C1["agm"]
        C2["levy-notices"]
        C3["financial"]
        C4["insurance"]
        C5["bylaws"]
        C6["correspondence"]
        C7["maintenance"]
        C8["contracts"]
        C9["building-reports"]
        C10["other"]
    end

    subgraph retention["Retention Period"]
        R1["7 years from meeting date"]
        R2["7 years from issue date"]
        R3["7 years from FY end"]
        R4["7 years from policy expiry"]
        R5["Permanent (until superseded)"]
        R6["7 years from date"]
        R7["7 years from completion"]
        R8["7 years from contract expiry"]
        R9["7 years from report date"]
        R10["7 years from upload date"]
    end

    subgraph deletion["Auto-Delete?"]
        D1["No (warn only)"]
        D2["No (warn only)"]
        D3["No (warn only)"]
        D4["Yes (expired policies)"]
        D5["No (permanent)"]
        D6["Yes (optional)"]
        D7["Yes (optional)"]
        D8["No (warn only)"]
        D9["No (warn only)"]
        D10["Yes (optional)"]
    end

    C1 --- R1 --- D1
    C2 --- R2 --- D2
    C3 --- R3 --- D3
    C4 --- R4 --- D4
    C5 --- R5 --- D5
    C6 --- R6 --- D6
    C7 --- R7 --- D7
    C8 --- R8 --- D8
    C9 --- R9 --- D9
    C10 --- R10 --- D10

    style D5 fill:#e6f3ff,stroke:#0066cc
    style D4 fill:#ffffcc,stroke:#cccc00
    style D6 fill:#ffffcc,stroke:#cccc00
    style D7 fill:#ffffcc,stroke:#cccc00
    style D10 fill:#ffffcc,stroke:#cccc00
```
